$(window).resize(function(){GPW.layout.tabbarLayout.setHeight(300),GPW.layout.mainLayout.setSizes()});var GPC={url:{refreshGridUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/loadPage/"+GLOBAL.P.CLASSNAME+"?"+GLOBAL.P.parameter,queryUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/queryPage/"+GLOBAL.P.CLASSNAME+"?"+GLOBAL.P.parameter,saveUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/save/"+GLOBAL.P.CLASSNAME+"?"+GLOBAL.P.parameter,detailQueryUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/tpl/DetailQuery/"+GLOBAL.P.CLASSNAME+"?"+GLOBAL.P.parameter,updateUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/updateAll/"+GLOBAL.P.CLASSNAME+"?"+GLOBAL.P.parameter+"&format=xml",delectUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/delect/"+GLOBAL.P.CLASSNAME,loadActiveTabUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/tpl/SingleGrid"},constant:{add:"add",edit:"edit",delect:"delect",query:"query",update:"update",detailQuery:"detailQuery",between:"between"}},GPW={layout:{},toolbar:{},grid:{},window:{},form:{},paging:{},cache:{},tabbar:{}};GPW.cache={grid:{}},GPW.layout={mainLayout:{},mainGridLayout:{},init:function(){this.mainLayout=new dhtmlXLayoutObject("layoutObj","2E"),this.mainGridLayout=this.mainLayout.cells("a"),this.mainGridLayout.setText("主表"),this.mainGridLayout.hideHeader(),this.tabbarLayout=this.mainLayout.cells("b"),this.tabbarLayout.setHeight(300),this.tabbarLayout.setText("从表"),this.tabbarLayout.hideHeader()},maximized:function(t){t?this.mainGridLayout.expand():this.mainGridLayout.collapse()}},GPW.grid={mainGrid:{},gridDataProcessor:{},init:function(){this.mainGrid=GPW.layout.mainGridLayout.attachGrid(),this.mainGrid.setImagePath(GLOBAL.IconsPath),this.mainGrid.setHeader(GLOBAL.P.P_GRID_HEADER),this.mainGrid.setColumnIds(GLOBAL.P.P_GRID_COLUMNIDS),this.mainGrid.setInitWidths(GLOBAL.P.P_GRID_WIDTH),this.mainGrid.setColAlign(GLOBAL.P.P_GRID_COLALIGN),this.mainGrid.setColTypes(GLOBAL.P.P_GRID_COLTYPES),this.mainGrid.setColSorting(GLOBAL.P.P_GRID_COLSORTING),this.mainGrid.setColValidators(GLOBAL.P.P_GRID_VALIDATORS),GLOBAL.initGridCombo(this.mainGrid,GLOBAL.P.P_GRID_FORMGRIDASSEMBLE),this.mainGrid.setDateFormat("%Y-%m-%d"),GLOBAL.S.SEC_U_V||this.mainGrid.setEditable(!1);var t="<div id='recinfoArea' /><div id='pagingArea' style='border:none;'/>",a=GPW.layout.mainGridLayout.attachStatusBar({height:28});a.setText(t),this.mainGrid.enablePaging(!0,20,5,"pagingArea",!0,"recInfoArea"),this.mainGrid.setPagingSkin("toolbar","dhx_skyblue"),this.mainGrid.i18n.paging=GLOBAL.paging,this.mainGrid.init(),this.mainGrid.attachEvent("onValidationError",function(t,a,e,i){parent.dhtmlx.message({type:"error",expire:-1,text:"校验错误："+GPW.grid.mainGrid.getColLabel(a)+","+GLOBAL.validText(i)+",字段值不能为["+e+"]！"})}),this.gridDataProcessor=new dataProcessor(GPC.url.updateUrl),this.gridDataProcessor.setTransactionMode("REST"),this.gridDataProcessor.setUpdateMode("off"),this.gridDataProcessor.enableDataNames(!0),this.gridDataProcessor.enablePartialDataSend(!0),this.gridDataProcessor.init(this.mainGrid),this.gridDataProcessor.attachEvent("onBeforeDataSending",function(t,a,e){return _.each(e,function(t){t.data&&(t.data=null,delete t.data)}),!0}),this.gridDataProcessor.attachEvent("onAfterUpdate",function(t,a,e,i){if(i instanceof Element&&null!=i.getElementsByTagName("code").item(0)){var r=i.getElementsByTagName("code").item(0).childNodes[0].nodeValue,n=i.getElementsByTagName("message").item(0).childNodes[0].nodeValue;-1==r&&parent.dhtmlx.message({type:"error",expire:-1,text:n})}}),this.mainGrid.attachEvent("onRowSelect",function(t){GPW.tabbar.loadActiveTab(t)}),this.mainGrid.attachEvent("onXLE",function(){SpinnerCtl.close()}),this.refreshMainGrid()},sendGridData:function(){this.gridDataProcessor.sendData()},doAfterRefresh:function(){var t=GPW.grid.mainGrid;t.selectRow(0);var a=t.getSelectedRowId();null!=a&&GPW.tabbar.loadActiveTab(a)},refreshMainGrid:function(t){t||(t=GPC.url.refreshGridUrl),this.mainGrid.clearAll(),SpinnerCtl.show(),this.mainGrid.load(t,this.doAfterRefresh,"js")},delectMainGrid:function(){var t=this.mainGrid.getSelectedRowId();return t?void dhtmlx.confirm({ok:"是",cancel:"否",text:"你确定删除此记录吗？ ",callback:function(a){a&&$.ajax({type:"GET",url:GPC.url.delectUrl,data:"id="+t,success:function(){GPW.grid.refreshMainGrid()}})}}):void dhtmlx.alert("请选中一条记录删除！")}},GPW.toolbar={mainToolbar:{},queryNames:GLOBAL.P.P_SIMPLE_QUERY_NAMES,queryValues:GLOBAL.P.P_SIMPLE_QUERY_VALUES,queryOperators:GLOBAL.P.P_SIMPLE_QUERY_OPERATOR,queryFormType:GLOBAL.P.P_SIMPLE_QUERY_FORM_TYPE,onChangeQuery:function(){this.addQueryValue()},onChangeQueryOperators:function(){var t=GPW.toolbar.mainToolbar,a=t.getInput("operator").value,e=GPW.toolbar.mainToolbar.getInput("queryName"),i=e.value;a==GPC.constant.between?this.addBetweenValue(i):this.addOtherValue(i)},addBetweenValue:function(t){this.mainToolbar.removeItem("queryValue"),this.mainToolbar.removeItem("queryBegin"),this.mainToolbar.removeItem("queryEnd"),this.mainToolbar.removeItem("text_do"),this.mainToolbar.addInput("queryBegin",3,"",100),this.mainToolbar.addText("text_do",4,"到"),this.mainToolbar.addInput("queryEnd",5,"",100);var a;if(_.map(this.queryFormType,function(e,i){return i==t?void(a=e):void 0}),"calendar"==a){new dhtmlXCalendarObject(this.mainToolbar.getInput("queryBegin")),new dhtmlXCalendarObject(this.mainToolbar.getInput("queryEnd"))}},addOtherValue:function(t){var a=GPW.toolbar.mainToolbar,e=!1;if(_.map(this.queryValues,function(i,r){r==t&&(a.removeItem("queryValue"),a.removeItem("queryBegin"),a.removeItem("text_do"),a.removeItem("queryEnd"),a.addSelectEx("queryValue",3,i,100),e=!0)}),!e){a.removeItem("queryValue"),a.removeItem("queryBegin"),a.removeItem("text_do"),a.removeItem("queryEnd");var i;_.map(this.queryFormType,function(a,e){return e==t?void(i=a):void 0}),a.addInput("queryValue",3,"",200),"calendar"==i&&new dhtmlXCalendarObject(a.getInput("queryValue"))}},addOperator:function(t){var a=GPW.toolbar.mainToolbar;_.find(this.queryOperators,function(e,i){return i==t?(a.removeItem("operator"),void a.addSelectEx("operator",2,e,70,"GPW.toolbar.onChangeQueryOperators()")):void 0})},addQueryName:function(){this.mainToolbar.addSelectEx("queryName",1,this.queryNames,100,"GPW.toolbar.onChangeQuery()")},addQueryValue:function(){var t=GPW.toolbar.mainToolbar.getInput("queryName"),a=t.value,e=this,i=e.mainToolbar;e.addOperator(a);var r=i.getInput("operator").value;r==GPC.constant.between?this.addBetweenValue(a):this.addOtherValue(a)},init:function(){this.mainToolbar=GPW.layout.mainGridLayout.attachToolbar();var t=this.mainToolbar,a=Array();GLOBAL.S.SEC_C_V&&a.push(Array(GPC.constant.add,"obj","新增","new.gif")),GLOBAL.S.SEC_U_V&&a.push(Array(GPC.constant.edit,"obj","修改","edit.gif")),GLOBAL.S.SEC_D_V&&a.push(Array(GPC.constant.delect,"obj","删除","delect.png")),t.setIconsPath(GLOBAL.IconsPath),t.addText("text_select",0,"选"),this.addQueryName();var e=t.getInput("queryName").value;this.addOperator(e),this.addQueryValue(),t.addButton("query",9,"查询","search.gif","search_dis.gif"),t.addSeparator("sep1",10),t.addButton("detailQuery",12,"详细查询","search.png","search_dis.png"),(GLOBAL.S.SEC_U_V||GLOBAL.S.SEC_C_V||GLOBAL.S.SEC_D_V)&&t.addButtonSelect("edit",15,"编辑",a,"edit.gif","edit_dis.gif"),GLOBAL.S.SEC_U_V&&t.addButton("update",16,"更新","cut.gif","cut_dis.gif"),t.addButton("maximized",20,"全屏","fullscreen_mode.gif","fullscreen_mode.gif"),this.mainToolbarClick()},mainToolbarClick:function(){this.mainToolbar.attachEvent("onClick",function(t){switch(t){case GPC.constant.add:GPW.window.initMainWindow(GPC.constant.add);break;case GPC.constant.edit:GPW.window.initMainWindow(GPC.constant.edit);break;case GPC.constant.delect:GPW.grid.delectMainGrid();break;case GPC.constant.query:var a=GPW.toolbar.mainToolbar,e=a.getInput("queryName").value,i=a.getInput("operator").value,r=new Array;if(i==GPC.constant.between){var n=a.getInput("queryBegin").value,o=a.getInput("queryEnd").value;r[0]=GLOBAL.getBetweenQueryObjct(e,i,n,o)}else{var d=a.getInput("queryValue").value;r[0]=GLOBAL.getQueryObjct(e,i,d)}var s=JSON.stringify(r),u=GPC.url.queryUrl+"&_json="+encodeURI(s);GPW.grid.refreshMainGrid(u);break;case GPC.constant.detailQuery:GPW.window.initDetailQueryWindow();break;case GPC.constant.update:GPW.grid.sendGridData();break;case"maximized":var l=GPW.layout,a=GPW.toolbar.mainToolbar;GLOBAL.P.MAXIMIZED?(l.tabbarLayout.expand(),a.setItemText("maximized","全屏"),a.setItemImage("maximized","fullscreen_mode.gif"),GLOBAL.P.MAXIMIZED=!1):(l.tabbarLayout.collapse(),a.setItemText("maximized","恢复"),a.setItemImage("maximized","selection.gif"),GLOBAL.P.MAXIMIZED=!0)}})}},GPW.window={handle:{},mainWindow:{},subWindow:{},createWindow:function(){this.initHandle(),this.handle.attachViewportTo("layoutObj"),this.mainWindow=this.handle.createWindow("w1",$("#layoutObj").width()/2-350,30,700,480)},initSubWindow:function(t,a){return this.initHandle(),this.handle.attachViewportTo("layoutObj"),this.subWindow=this.handle.createWindow("w1",$("#layoutObj").width()/2-t/2,30,t,a),this.subWindow},initHandle:function(){return this.handle=new dhtmlXWindows,this.handle},initMainWindow:function(t){if(t==GPC.constant.edit){var a=GPW.grid.mainGrid.getSelectedRowId();if(!a)return void dhtmlx.alert("请选中一条记录！")}this.createWindow(),this.mainWindow.setText(t==GPC.constant.add?"新增":"修改"),this.mainWindow.setModal(!0),GPW.form.init(this.mainWindow,t)},initDetailQueryWindow:function(){GPW.cache.grid=GPW.grid.mainGrid,this.createWindow(),this.mainWindow.setText("详细查询"),this.mainWindow.setModal(!0),this.mainWindow.attachURL(GPC.url.detailQueryUrl)}},GPW.form={mainForm:{},getMainFormData:function(){return GLOBAL.P.P_FORM},updateMainFromData:function(){var t=GPW.grid.mainGrid,a=t.getSelectedRowId();t.forEachCell(a,function(a,e){var i=t.getColumnId(e);GPW.form.mainForm.setItemValue(i,_.unescape(a.getValue()))}),GPW.form.mainForm.setItemValue("id",a)},getForm:function(t,a){return t.attachForm(a)},init:function(t,a){var e=this.getMainFormData();this.mainForm=this.getForm(t,e),a==GPC.constant.edit&&this.updateMainFromData(),this.mainForm.attachEvent("onInfo",function(t,a){GLOBAL.PopupFunction(a,this.getUserData(t,"info"))}),this.mainForm.attachEvent("onButtonClick",function(t){"save"==t&&GPW.form.mainForm.send(GPC.url.saveUrl,function(t,a){var e;e=parent.GPW?parent.GPW.window:GPW.window,e.handle.unload(),GLOBAL.errorMessage(a),GPW.grid.refreshMainGrid()})}),this.mainForm.attachEvent("onValidateError",function(t,a){parent.dhtmlx.message({type:"error",expire:-1,text:"校验错误："+GPW.form.mainForm.getItemLabel(t)+"字段值不能为["+a+"]！"})})}},GPW.tabbar={subListTabbar:{},subInfo:GLOBAL.P.P_SUB_INFO,getTabs:function(){for(var t=GPW.tabbar.subInfo,a=new Array(t.length),e=0;e<t.length;e++){var i={};i.id=t[e].name,i.text=t[e].alias,0==e&&(i.active=!0),a[e]=i}return a},attachURL:function(t,a){var e=GPW.tabbar.subInfo,i=_.find(e,function(a){return a.name==t?a:void 0}),r=GPC.url.loadActiveTabUrl+"/"+t+"/d?_key="+i.oneName+".id&_value="+a;this.subListTabbar.tabs(t).attachURL(r)},initSubList:function(){this.subListTabbar=GPW.layout.tabbarLayout.attachTabbar({tabs:GPW.tabbar.getTabs()}),this.subListTabbar.attachEvent("onSelect",function(t){var a=GPW.grid.mainGrid,e=a.getSelectedRowId();return GPW.tabbar.attachURL(t,e),!0})},loadActiveTab:function(t){var a=this.subListTabbar.getActiveTab();this.attachURL(a,t)}},$(function(){GPW.layout.init(),GPW.grid.init(),GPW.toolbar.init(),GPW.tabbar.initSubList()}),dhtmlxValidation.isValidIntegerEmpty=function(t){return""==t?!0:dhtmlxValidation.isValidInteger(t)},dhtmlxValidation.isValidNumericEmpty=function(t){return""==t?!0:dhtmlxValidation.isValidNumeric(t)};