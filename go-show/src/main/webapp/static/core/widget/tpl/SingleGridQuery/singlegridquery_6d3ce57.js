$(window).resize(function(){GPW.layout.mainLayout.setSizes()});var GPC={url:{queryUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/queryPage/"+GLOBAL.P.CLASSNAME,updateUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/updateAll/"+GLOBAL.P.CLASSNAME+"?format=xml",saveUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/save/"+GLOBAL.P.CLASSNAME,delectUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/delect/"+GLOBAL.P.CLASSNAME,toPdfUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/topdf/"+GLOBAL.P.CLASSNAME,toExcelUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/toexcel/"+GLOBAL.P.CLASSNAME,importExcelDataUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/inexcel/"+GLOBAL.P.CLASSNAME+"/"+GLOBAL.V.InExcelName,refreshGridUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/loadPage/"+GLOBAL.P.CLASSNAME},constant:{add:"add",edit:"edit",delect:"delect",query:"query",update:"update",detailQuery:"detailQuery",between:"between"}},GPW={layout:{},toolbar:{},grid:{},paging:{}};GPW.layout={mainLayout:{},mainGridLayout:{},queryLayout:{},init:function(){this.mainLayout=new dhtmlXLayoutObject("layoutObj","2E"),this.queryLayout=this.mainLayout.cells("a"),this.queryLayout.setHeight(GLOBAL.V.QueryHeight),this.queryLayout.hideHeader(),this.mainGridLayout=this.mainLayout.cells("b"),this.mainGridLayout.hideHeader()}},GPW.grid={mainGrid:{},gridDataProcessor:{},inDataProcessor:{},init:function(){this.mainGrid=GPW.layout.mainGridLayout.attachGrid(),this.mainGrid.setImagePath(GLOBAL.IconsPath),this.mainGrid.setHeader(GLOBAL.P.P_GRID_HEADER),this.mainGrid.setColumnIds(GLOBAL.P.P_GRID_COLUMNIDS),this.mainGrid.setInitWidths(GLOBAL.P.P_GRID_WIDTH),this.mainGrid.setColAlign(GLOBAL.P.P_GRID_COLALIGN),this.mainGrid.setColTypes(GLOBAL.P.P_GRID_COLTYPES),this.mainGrid.setColSorting(GLOBAL.P.P_GRID_COLSORTING),this.mainGrid.setColValidators(GLOBAL.P.P_GRID_VALIDATORS),GLOBAL.initGridCombo(this.mainGrid,GLOBAL.P.P_GRID_FORMGRIDASSEMBLE),this.mainGrid.setDateFormat("%Y-%m-%d"),this.mainGrid.setEditable(GLOBAL.P.tableEdit);var t="<div id='recinfoArea' /><div id='pagingArea' style='border:none;'/>",e=GPW.layout.mainGridLayout.attachStatusBar({height:28});e.setText(t),this.mainGrid.enablePaging(!0,20,5,"pagingArea",!0,"recInfoArea"),this.mainGrid.setPagingSkin("toolbar","dhx_skyblue"),this.mainGrid.i18n.paging=GLOBAL.paging,this.gridDataProcessor=new dataProcessor(GPC.url.updateUrl),this.gridDataProcessor.setTransactionMode("REST"),this.gridDataProcessor.setUpdateMode("off"),this.gridDataProcessor.enableDataNames(!0),this.gridDataProcessor.enablePartialDataSend(!0),this.gridDataProcessor.init(this.mainGrid),this.gridDataProcessor.attachEvent("onBeforeDataSending",function(t,e,a){return _.each(a,function(t){t.data&&(t.data=null,delete t.data)}),!0}),this.gridDataProcessor.attachEvent("onAfterUpdate",function(t,e,a,i){if(i instanceof Element&&null!=i.getElementsByTagName("code").item(0)){var n=i.getElementsByTagName("code").item(0).childNodes[0].nodeValue,r=i.getElementsByTagName("message").item(0).childNodes[0].nodeValue;-1==n&&parent.dhtmlx.message({type:"error",expire:-1,text:r})}}),this.mainGrid.init(),this.mainGrid.attachEvent("onXLE",function(){SpinnerCtl.close()}),this.refreshMainGrid()},sendGridData:function(){this.gridDataProcessor.sendData()},delectMainGrid:function(){var t=this.mainGrid.getSelectedRowId();return t?void dhtmlx.confirm({ok:"是",cancel:"否",text:"你确定删除此记录吗？ ",callback:function(e){e&&$.ajax({type:"GET",url:GPC.url.delectUrl,data:"id="+t,success:function(){GPW.grid.refreshMainGrid()}})}}):void dhtmlx.alert("请选中一条记录删除！")},refreshMainGrid:function(t){t||(t=GPC.url.refreshGridUrl),this.mainGrid.clearAll(),SpinnerCtl.show(),this.mainGrid.load(t,"js")},callbackParse:function(){GPW.grid.mainGrid.forEachRow(function(t){GPW.grid.gridDataProcessor.setUpdated(t,"inserted"),GPW.grid.gridDataProcessor.obj.setUserData(t,GPW.grid.gridDataProcessor.action_param,"inserted")}),GPW.grid.gridDataProcessor.enablePartialDataSend(!1)},inMainGrid:function(t){this.mainGrid.clearAll(),SpinnerCtl.show(),GLOBAL.P.tableEdit=!0,GPW.toolbar.tableEditToolbar(GLOBAL.P.tableEdit),this.mainGrid.parse(t,this.callbackParse,"js")}},GPW.toolbar={mainToolbar:{},init:function(){if(GLOBAL.S.SEC_U_V||GLOBAL.S.SEC_D_V){this.mainToolbar=GPW.layout.queryLayout.attachToolbar();var t=this.mainToolbar;t.setIconsPath(GLOBAL.IconsPath),GLOBAL.S.SEC_U_V&&t.addButton(GPC.constant.edit,1,"修改","edit.gif","edit_dis.gif"),GLOBAL.S.SEC_D_V&&t.addButton(GPC.constant.delect,7,"删除","delect.png","delect.png"),GLOBAL.S.SEC_U_V&&(GLOBAL.P.tableEdit?(t.addButton(GPC.constant.add,0,"新增一行","new.gif","new_dis.gif"),t.addButton(GPC.constant.update,2,"更新","cut.gif","cut_dis.gif"),t.addButton("tableEdit",15,"关闭表格编辑","icon_grid.gif","icon_grid.gif"),t.hideItem(GPC.constant.edit)):(t.addButton(GPC.constant.add,0,"新增","new.gif","new_dis.gif"),t.addButton(GPC.constant.update,2,"更新","cut.gif","cut_dis.gif"),t.addButton("tableEdit",15,"启用表格编辑","cancel.gif","cancel.gif"),t.hideItem("update"))),this.mainToolbarClick()}},tableEditToolbar:function(t){var e=GPW.toolbar.mainToolbar;t?(e.showItem(GPC.constant.update),e.hideItem(GPC.constant.edit),e.setItemText("tableEdit","关闭表格编辑"),e.setItemImage("tableEdit","icon_grid.gif"),e.setItemText(GPC.constant.add,"新增一行")):(e.hideItem(GPC.constant.update),e.showItem(GPC.constant.edit),e.setItemText("tableEdit","启用表格编辑"),e.setItemImage("tableEdit","cancel.gif"),e.setItemText(GPC.constant.add,"新增")),GPW.grid.mainGrid.setEditable(t)},mainToolbarClick:function(){this.mainToolbar.attachEvent("onClick",function(t){switch(t){case GPC.constant.add:GLOBAL.P.tableEdit?GPW.grid.mainGrid.addRow(GPW.grid.mainGrid.uid(),"",0):GPW.window.initMainWindow(GPC.constant.add);break;case GPC.constant.edit:GPW.window.initMainWindow(GPC.constant.edit);break;case GPC.constant.delect:GPW.grid.delectMainGrid();break;case GPC.constant.update:GPW.grid.sendGridData();break;case"tableEdit":GLOBAL.P.tableEdit=!GLOBAL.P.tableEdit,GPW.toolbar.tableEditToolbar(GLOBAL.P.tableEdit)}})}},GPW.form={mainForm:{},getMainFormData:function(){return GLOBAL.P.P_FORM},updateMainFromData:function(){var t=GPW.grid.mainGrid,e=t.getSelectedRowId();t.forEachCell(e,function(e,a){var i=t.getColumnId(a);GPW.form.mainForm.setItemValue(i,_.unescape(e.getValue()))}),GPW.form.mainForm.setItemValue("id",e)},getForm:function(t,e){return t.attachForm(e)},init:function(t,e){var a=this.getMainFormData();this.mainForm=this.getForm(t,a),e==GPC.constant.edit&&this.updateMainFromData(),this.mainForm.attachEvent("onButtonClick",function(t){"save"==t&&GPW.form.mainForm.send(GPC.url.saveUrl,function(t,e){var a;if(a=parent.GPW?parent.GPW.window:GPW.window,a.handle.unload(),e.length>0){var i=JSON.parse(e);GLOBAL.errorMessage(i)}GPW.grid.refreshMainGrid()})}),this.mainForm.attachEvent("onInfo",function(t,e){GLOBAL.PopupFunction(e,this.getUserData(t,"info"))}),this.mainForm.attachEvent("onValidateError",function(t,e){parent.dhtmlx.message({type:"error",expire:-1,text:"校验错误："+GPW.form.mainForm.getItemLabel(t)+"字段值不能为["+e+"]！"})})},queryForm:{},allQueryForm:GLOBAL.P.P_TOP_FORM,queryJson:function(){var t=this.queryForm,e=0,a=new Array;return t.forEachItem(function(i){var n=t.getItemType(i);if("input"==n||"combo"==n||"calendar"==n){var r=i.lastIndexOf("_End");if(0>r){var o=i.lastIndexOf("_Begin");if(o>-1){var d=i.substring(0,o),s=t.getInput(d+"_End").value,l=t.getInput(i).value;l&&s&&(a[e]=GLOBAL.getBetweenQueryObjct(d,"between",l,s),e++)}else{var c=t.getItemValue(i);_.isEmpty(c)||(a[e]=GLOBAL.getQueryObjct(i,"=",c),e++)}}}}),JSON.stringify(a)},initTop:function(){if("1"==GLOBAL.V.ImportExcelData){var t=$("<div id='fileDiv'><form id='realForm' method='POST' enctype='multipart/form-data' style='margin-right: 60px;'><div id='dhxForm'></div></form></div>");$(document.body.firstChild).before(t),this.queryForm=new dhtmlXForm("dhxForm",this.allQueryForm),GPW.layout.queryLayout.attachObject("fileDiv")}else this.queryForm=GPW.layout.queryLayout.attachForm(this.allQueryForm);var t=this.queryForm,e=[{type:"button",name:"query",value:"查询"},{type:"newcolumn"},{type:"button",name:"reset",value:"重置"}];"1"==GLOBAL.V.ExportExcel&&(e=_.union(e,[{type:"newcolumn"},{type:"button",name:"excel",value:"导出Excel"}])),"1"==GLOBAL.V.ExportPdf&&(e=_.union(e,[{type:"newcolumn"},{type:"button",name:"pdf",value:"导出PDF"}])),"1"==GLOBAL.V.ImportExcelData&&(e=_.union(e,[{type:"newcolumn"},{type:"button",name:"ImportExcelData",value:"导入Excel"},{type:"newcolumn"},{type:"file",offsetTop:10,name:"file"}]));var a={type:"block",width:800,name:"blockButton",list:e};t.addItem(null,a),t.attachEvent("onInfo",function(t,e){GLOBAL.PopupFunction(e,this.getUserData(t,"info"))}),t.attachEvent("onButtonClick",function(t){function e(t){GPW.grid.inMainGrid(t)}switch(t){case"excel":var a=GPW.form.queryJson();window.location.href=GPC.url.toExcelUrl+"?_json="+encodeURI(a)+"&_report="+GLOBAL.V.ExportReportName;break;case"pdf":var a=GPW.form.queryJson();window.location.href=GPC.url.toPdfUrl+"?_json="+encodeURI(a)+"&_report="+GLOBAL.V.ExportReportName;break;case"ImportExcelData":$("#realForm").attr("action",GPC.url.importExcelDataUrl),$("#realForm").ajaxForm({dataType:"json",error:function(t){alert(t.responseText)},success:e}),$("#realForm").submit();break;case"reset":var i=GPW.form.queryForm;i.forEachItem(function(t){var e=i.getItemType(t);"hidden"!=e&&"block"!=e&&"button"!=e&&i.setItemValue(t,"")});case"query":var n=0,r=new Array,i=GPW.form.queryForm;i.forEachItem(function(t){var e=i.getItemType(t);if("input"==e||"combo"==e||"calendar"==e){var a=t.lastIndexOf("_End");if(0>a){var o=t.lastIndexOf("_Begin"),d=t.substring(0,o),s=i.getInput(d+"_End");if(o>-1&&null!=s){var l=i.getInput(d+"_End").value,c=s.value;c&&l&&(r[n]=GLOBAL.getBetweenQueryObjct(d,"between",c,l),n++)}else{var G=i.getItemValue(t),u=i.getItemValue(t+"_options");u||(u="="),_.isEmpty(G)||(r[n]=GLOBAL.getQueryObjct(t,u,G),n++)}}}});var a=JSON.stringify(r),o=GPW.grid.mainGrid;o.clearAll(),SpinnerCtl.show(),o.load(GPC.url.queryUrl+"?_json="+encodeURI(a),"js")}})}},GPW.window={handle:{},mainWindow:{},createWindow:function(){parent.GPW?(this.mainWindow=parent.GPW.window.initSubWindow(),parent.GPW.cache.grid=GPW.grid.mainGrid):(this.initHandle(),this.handle.attachViewportTo("layoutObj"),this.mainWindow=this.handle.createWindow("w1",$("#layoutObj").width()/2-GLOBAL.V.MainWindowWidth/2,30,GLOBAL.V.MainWindowWidth,GLOBAL.V.MainWindowHeight))},initHandle:function(){return this.handle=new dhtmlXWindows,this.handle},initMainWindow:function(t){if(t==GPC.constant.edit){var e=GPW.grid.mainGrid.getSelectedRowId();if(!e)return void dhtmlx.alert("请选中一条记录！")}this.createWindow(),this.mainWindow.setText(t==GPC.constant.add?"新增":"修改"),this.mainWindow.setModal(!0),GPW.form.init(this.mainWindow,t)}},$(function(){GPW.layout.init(),GPW.grid.init(),GPW.form.initTop(),GPW.toolbar.init()});