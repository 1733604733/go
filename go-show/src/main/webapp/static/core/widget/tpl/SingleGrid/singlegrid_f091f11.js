$(window).resize(function(){GPW.layout.mainLayout.setSizes()});var GPC={url:{refreshGridUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/loadPage/"+GLOBAL.P.CLASSNAME+"?"+GLOBAL.P.parameter,queryUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/queryPage/"+GLOBAL.P.CLASSNAME+"?"+GLOBAL.P.parameter,saveUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/save/"+GLOBAL.P.CLASSNAME+"?"+GLOBAL.P.parameter,detailQueryUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/tpl/DetailQuery/"+GLOBAL.P.CLASSNAME+"/d?"+GLOBAL.P.parameter,updateUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/updateAll/"+GLOBAL.P.CLASSNAME+"?format=xml&"+GLOBAL.P.parameter,delectUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/delect/"+GLOBAL.P.CLASSNAME},constant:{add:"add",edit:"edit",delect:"delect",query:"query",update:"update",detailQuery:"detailQuery",between:"between"}},GPW={layout:{},toolbar:{},grid:{},window:{},form:{},paging:{}};GPW.layout={mainLayout:{},mainGridLayout:{},init:function(){this.mainLayout=new dhtmlXLayoutObject("layoutObj","1C"),this.mainGridLayout=this.mainLayout.cells("a"),this.mainGridLayout.hideHeader()}},GPW.grid={mainGrid:{},gridDataProcessor:{},init:function(){this.mainGrid=GPW.layout.mainGridLayout.attachGrid(),this.mainGrid.setImagePath(GLOBAL.IconsPath),this.mainGrid.setHeader(GLOBAL.P.P_GRID_HEADER),this.mainGrid.setColumnIds(GLOBAL.P.P_GRID_COLUMNIDS),this.mainGrid.setInitWidths(GLOBAL.P.P_GRID_WIDTH),this.mainGrid.setColAlign(GLOBAL.P.P_GRID_COLALIGN),this.mainGrid.setColTypes(GLOBAL.P.P_GRID_COLTYPES),this.mainGrid.setColSorting(GLOBAL.P.P_GRID_COLSORTING),this.mainGrid.setColValidators(GLOBAL.P.P_GRID_VALIDATORS),GLOBAL.initGridCombo(this.mainGrid,GLOBAL.P.P_GRID_FORMGRIDASSEMBLE),this.mainGrid.setDateFormat("%Y-%m-%d"),GLOBAL.S.SEC_U_V||this.mainGrid.setEditable(!1);var e="<div id='recinfoArea' /><div id='pagingArea' style='border:none;'/>",t=GPW.layout.mainGridLayout.attachStatusBar({height:28});t.setText(e),this.mainGrid.enablePaging(!0,20,5,"pagingArea",!0,"recInfoArea"),this.mainGrid.setPagingSkin("toolbar","dhx_skyblue"),this.mainGrid.i18n.paging=GLOBAL.paging,this.mainGrid.init(),this.mainGrid.attachEvent("onValidationError",function(e,t,a,i){parent.dhtmlx.message({type:"error",expire:-1,text:"校验错误："+GPW.grid.mainGrid.getColLabel(t)+","+GLOBAL.validText(i)+",字段值不能为["+a+"]！"})}),this.gridDataProcessor=new dataProcessor(GPC.url.updateUrl),this.gridDataProcessor.setTransactionMode("REST"),this.gridDataProcessor.setUpdateMode("off"),this.gridDataProcessor.enableDataNames(!0),this.gridDataProcessor.enablePartialDataSend(!0),this.gridDataProcessor.init(this.mainGrid),this.gridDataProcessor.attachEvent("onBeforeDataSending",function(e,t,a){return _.each(a,function(e){e.data&&(e.data=null,delete e.data)}),!0}),this.gridDataProcessor.attachEvent("onAfterUpdate",function(e,t,a,i){if(i instanceof Element&&null!=i.getElementsByTagName("code").item(0)){var n=i.getElementsByTagName("code").item(0).childNodes[0].nodeValue,r=i.getElementsByTagName("message").item(0).childNodes[0].nodeValue;-1==n&&parent.dhtmlx.message({type:"error",expire:-1,text:r})}}),this.mainGrid.attachEvent("onXLE",function(){SpinnerCtl.close()}),this.refreshMainGrid()},sendGridData:function(){this.gridDataProcessor.sendData()},refreshMainGrid:function(e){e||(e=GPC.url.refreshGridUrl),this.mainGrid.clearAll(),SpinnerCtl.show(),this.mainGrid.load(e,"js")},delectMainGrid:function(){var e=this.mainGrid.getSelectedRowId();return e?void dhtmlx.confirm({ok:"是",cancel:"否",text:"你确定删除此记录吗？ ",callback:function(t){t&&$.ajax({type:"GET",url:GPC.url.delectUrl,data:"id="+e,success:function(){GPW.grid.refreshMainGrid()}})}}):void dhtmlx.alert("请选中一条记录删除！")}},GPW.toolbar={mainToolbar:{},queryNames:GLOBAL.P.P_SIMPLE_QUERY_NAMES,queryValues:GLOBAL.P.P_SIMPLE_QUERY_VALUES,queryOperators:GLOBAL.P.P_SIMPLE_QUERY_OPERATOR,queryFormType:GLOBAL.P.P_SIMPLE_QUERY_FORM_TYPE,onChangeQuery:function(){this.addQueryValue()},onChangeQueryOperators:function(){var e=GPW.toolbar.mainToolbar,t=e.getInput("operator").value,a=GPW.toolbar.mainToolbar.getInput("queryName"),i=a.value;t==GPC.constant.between?this.addBetweenValue(i):this.addOtherValue(i)},addBetweenValue:function(e){this.mainToolbar.removeItem("queryValue"),this.mainToolbar.removeItem("queryBegin"),this.mainToolbar.removeItem("queryEnd"),this.mainToolbar.removeItem("text_do"),this.mainToolbar.addInput("queryBegin",3,"",100),this.mainToolbar.addText("text_do",4,"到"),this.mainToolbar.addInput("queryEnd",5,"",100);var t;if(_.map(this.queryFormType,function(a,i){return i==e?void(t=a):void 0}),"calendar"==t){new dhtmlXCalendarObject(this.mainToolbar.getInput("queryBegin")),new dhtmlXCalendarObject(this.mainToolbar.getInput("queryEnd"))}},addOtherValue:function(e){var t=GPW.toolbar.mainToolbar,a=!1;if(_.map(this.queryValues,function(i,n){n==e&&(t.removeItem("queryValue"),t.removeItem("queryBegin"),t.removeItem("text_do"),t.removeItem("queryEnd"),t.addSelectEx("queryValue",3,i,100),a=!0)}),!a){t.removeItem("queryValue"),t.removeItem("queryBegin"),t.removeItem("text_do"),t.removeItem("queryEnd");var i;_.map(this.queryFormType,function(t,a){return a==e?void(i=t):void 0}),t.addInput("queryValue",3,"",200),"calendar"==i&&new dhtmlXCalendarObject(t.getInput("queryValue"))}},addOperator:function(e){var t=GPW.toolbar.mainToolbar;_.find(this.queryOperators,function(a,i){return i==e?(t.removeItem("operator"),void t.addSelectEx("operator",2,a,70,"GPW.toolbar.onChangeQueryOperators()")):void 0})},addQueryName:function(){this.mainToolbar.addSelectEx("queryName",1,this.queryNames,100,"GPW.toolbar.onChangeQuery()")},addQueryValue:function(){var e=GPW.toolbar.mainToolbar.getInput("queryName"),t=e.value,a=this,i=a.mainToolbar;a.addOperator(t);var n=i.getInput("operator").value;n==GPC.constant.between?this.addBetweenValue(t):this.addOtherValue(t)},init:function(){this.mainToolbar=GPW.layout.mainGridLayout.attachToolbar();var e=this.mainToolbar,t=Array();GLOBAL.S.SEC_C_V&&t.push(Array(GPC.constant.add,"obj","新增","new.gif")),GLOBAL.S.SEC_U_V&&t.push(Array(GPC.constant.edit,"obj","修改","edit.gif")),GLOBAL.S.SEC_D_V&&t.push(Array(GPC.constant.delect,"obj","删除","delect.png")),e.setIconsPath(GLOBAL.IconsPath),e.addText("text_select",0,"选"),this.addQueryName();var a=e.getInput("queryName").value;this.addOperator(a),this.addQueryValue(),e.addButton("query",9,"查询","search.gif","search_dis.gif"),e.addSeparator("sep1",10),e.addButton("detailQuery",12,"详细查询","search.png","search_dis.png"),(GLOBAL.S.SEC_U_V||GLOBAL.S.SEC_C_V||GLOBAL.S.SEC_D_V)&&e.addButtonSelect("edit",15,"编辑",t,"edit.gif","edit_dis.gif"),GLOBAL.S.SEC_U_V&&e.addButton("update",16,"更新","cut.gif","cut_dis.gif"),e.addButton("maximized",20,"全屏","fullscreen_mode.gif","fullscreen_mode.gif"),this.mainToolbarClick()},mainToolbarClick:function(){this.mainToolbar.attachEvent("onClick",function(e){switch(e){case GPC.constant.add:GPW.window.initMainWindow(GPC.constant.add);break;case GPC.constant.edit:GPW.window.initMainWindow(GPC.constant.edit);break;case GPC.constant.delect:GPW.grid.delectMainGrid();break;case GPC.constant.query:var t=GPW.toolbar.mainToolbar,a=t.getInput("queryName").value,i=t.getInput("operator").value,n=new Array;if(i==GPC.constant.between){var r=t.getInput("queryBegin").value,o=t.getInput("queryEnd").value;n[0]=GLOBAL.getBetweenQueryObjct(a,i,r,o)}else{var d=t.getInput("queryValue").value;n[0]=GLOBAL.getQueryObjct(a,i,d)}var s=JSON.stringify(n),l=GPC.url.queryUrl+"&_json="+encodeURI(s);GPW.grid.refreshMainGrid(l);break;case GPC.constant.detailQuery:GPW.window.initDetailQueryWindow();break;case GPC.constant.update:GPW.grid.sendGridData();break;case"maximized":var t=GPW.toolbar.mainToolbar;parent.GPW.layout.maximized&&(parent.GPW.layout.maximized(GLOBAL.P.MAXIMIZED),GLOBAL.P.MAXIMIZED?(t.setItemText("maximized","全屏"),t.setItemImage("maximized","fullscreen_mode.gif"),GLOBAL.P.MAXIMIZED=!1):(t.setItemText("maximized","恢复"),t.setItemImage("maximized","selection.gif"),GLOBAL.P.MAXIMIZED=!0))}})}},GPW.window={handle:{},mainWindow:{},createWindow:function(){parent.GPW?(this.mainWindow=parent.GPW.window.initSubWindow(GLOBAL.V.MainWindowWidth,GLOBAL.V.MainWindowHeight),parent.GPW.cache.grid=GPW.grid.mainGrid):(this.initHandle(),this.handle.attachViewportTo("layoutObj"),this.mainWindow=this.handle.createWindow("w1",$("#layoutObj").width()/2-GLOBAL.V.MainWindowWidth/2,30,GLOBAL.V.MainWindowWidth,GLOBAL.V.MainWindowHeight))},initHandle:function(){return this.handle=new dhtmlXWindows,this.handle},initMainWindow:function(e){if(e==GPC.constant.edit){var t=GPW.grid.mainGrid.getSelectedRowId();if(!t)return void dhtmlx.alert("请选中一条记录！")}this.createWindow(),this.mainWindow.setText(e==GPC.constant.add?"新增":"修改"),this.mainWindow.setModal(!0),GPW.form.init(this.mainWindow,e)},initDetailQueryWindow:function(){this.createWindow(),this.mainWindow.setText("详细查询"),this.mainWindow.setModal(!0),this.mainWindow.attachURL(GPC.url.detailQueryUrl)}},GPW.form={mainForm:{},getMainFormData:function(){return GLOBAL.P.P_FORM},updateMainFromData:function(){var e=GPW.grid.mainGrid,t=e.getSelectedRowId();e.forEachCell(t,function(t,a){var i=e.getColumnId(a);GPW.form.mainForm.setItemValue(i,_.unescape(t.getValue()))}),GPW.form.mainForm.setItemValue("id",t)},getForm:function(e,t){return e.attachForm(t)},init:function(e,t){var a=this.getMainFormData();this.mainForm=this.getForm(e,a),t==GPC.constant.edit&&this.updateMainFromData(),this.mainForm.attachEvent("onInfo",function(e,t){parent.GLOBAL.PopupFunction(t,this.getUserData(e,"info"))}),this.mainForm.attachEvent("onButtonClick",function(e){"save"==e&&(SpinnerCtl.show(),GPW.form.mainForm.send(GPC.url.saveUrl,function(e,t){SpinnerCtl.close();var a;a=parent.GPW?parent.GPW.window:GPW.window,a.handle.unload(),GLOBAL.errorMessage(t),GPW.grid.refreshMainGrid()}))}),this.mainForm.attachEvent("onValidateError",function(e,t){parent.dhtmlx.message({type:"error",expire:-1,text:"校验错误："+GPW.form.mainForm.getItemLabel(e)+"字段值不能为["+t+"]！"})})}},$(function(){GPW.layout.init(),GPW.grid.init(),GPW.toolbar.init()}),dhtmlxValidation.isValidIntegerEmpty=function(e){return""==e?!0:dhtmlxValidation.isValidInteger(e)},dhtmlxValidation.isValidNumericEmpty=function(e){return""==e?!0:dhtmlxValidation.isValidNumeric(e)};