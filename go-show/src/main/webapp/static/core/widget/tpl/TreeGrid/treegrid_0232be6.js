$(window).resize(function(){GPW.layout.treeLayout.setWidth(200),GPW.layout.mainLayout.setSizes()});var GPC={url:{treeQueryUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/queryIdToTree/"+GLOBAL.P.TREECLASS,dragOrderUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/dragTree/"+GLOBAL.P.TREECLASS,treeSave:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/treeSave/"+GLOBAL.P.TREECLASS,treeGetUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/get/"+GLOBAL.P.TREECLASS,treeDelectUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/delect/"+GLOBAL.P.TREECLASS,refreshGridUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/loadPage/"+GLOBAL.P.CLASSNAME+"?_key="+GLOBAL.P.TREEONENAME+".id",queryUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/queryPage/"+GLOBAL.P.CLASSNAME+"?_key="+GLOBAL.P.TREEONENAME+".id",saveUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/save/"+GLOBAL.P.CLASSNAME+"?_key="+GLOBAL.P.TREEONENAME+".id",detailQueryUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/tpl/DetailQuery/"+GLOBAL.P.CLASSNAME+"/d?_key="+GLOBAL.P.TREEONENAME+".id",updateUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/updateAll/"+GLOBAL.P.CLASSNAME+"?format=xml&_key="+GLOBAL.P.TREEONENAME+".id",delectUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/delect/"+GLOBAL.P.CLASSNAME,loadActiveTabUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/tpl/SingleGrid"},constant:{add:"add",edit:"edit",delect:"delect",query:"query",select:"select",update:"update",detailQuery:"detailQuery",between:"between"}},GPW={layout:{},toolbar:{},tree:{},grid:{},window:{},form:{},paging:{},cache:{}};GPW.cache={grid:{}},GPW.layout={mainLayout:{},mainGridLayout:{},treeLayout:{},init:function(){this.mainLayout=new dhtmlXLayoutObject("layoutObj","2U"),this.treeLayout=this.mainLayout.cells("a"),this.treeLayout.setWidth(200),this.treeLayout.hideHeader(),this.mainGridLayout=this.mainLayout.cells("b"),this.mainGridLayout.hideHeader()}},GPW.tree={mainTree:{},init:function(){this.mainTree=GPW.layout.treeLayout.attachTree(),this.mainTree.setImagePath(GLOBAL.IconsPath+"dhxtree_skyblue/"),this.mainTree.enableTreeImages("false"),this.mainTree.setXMLAutoLoading(GPC.url.treeQueryUrl),this.mainTree.setDataMode("json"),this.mainTree.loadJSON(GPC.url.treeQueryUrl),GLOBAL.S.SEC_U_V&&this.dragOrder(),this.onClick()},onClick:function(){this.mainTree.attachEvent("onClick",function(e){if(!this.hasChildren(e)){var t=GPC.url.refreshGridUrl+"&_value="+e;GPW.grid.refreshMainGrid(t)}return!0})},delectTree:function(){var e=GPW.tree.mainTree,t=e.getSelectedItemId();t&&dhtmlx.confirm({title:"删除树节点",ok:"是",cancel:"否",text:"您确认删除树节点: "+e.getItemText(t),callback:function(a){a&&$.ajax({type:"GET",url:GPC.url.treeDelectUrl,data:"id="+t,success:function(){e.refreshItem()}})}})},dragOrder:function(){this.mainTree.enableDragAndDrop(!0),this.mainTree.setDragBehavior("complex"),this.mainTree.attachEvent("onDrag",function(e,t,a){var r="sid="+e+"&tid="+t;a&&(r+="&id="+a),$.ajax({type:"GET",url:GPC.url.dragOrderUrl,data:r,success:function(){var r=GPW.tree.mainTree;if(0==t)r.refreshItem();else{var i=r.getParentId(e),n=r.getParentId(t);a?i==t?r.refreshItem(t):r.refreshItem():i==n?0==i?r.refreshItem():r.refreshItem(i):i!=t?r.refreshItem():r.refreshItem(i)}}})})}},GPW.grid={mainGrid:{},gridDataProcessor:{},init:function(){this.mainGrid=GPW.layout.mainGridLayout.attachGrid(),this.mainGrid.setImagePath(GLOBAL.IconsPath),this.mainGrid.setHeader(GLOBAL.P.P_GRID_HEADER),this.mainGrid.setColumnIds(GLOBAL.P.P_GRID_COLUMNIDS),this.mainGrid.setInitWidths(GLOBAL.P.P_GRID_WIDTH),this.mainGrid.setColAlign(GLOBAL.P.P_GRID_COLALIGN),this.mainGrid.setColTypes(GLOBAL.P.P_GRID_COLTYPES),this.mainGrid.setColSorting(GLOBAL.P.P_GRID_COLSORTING),this.mainGrid.setColValidators(GLOBAL.P.P_GRID_VALIDATORS),GLOBAL.initGridCombo(this.mainGrid,GLOBAL.P.P_GRID_FORMGRIDASSEMBLE),this.mainGrid.setDateFormat("%Y-%m-%d"),GLOBAL.S.SEC_U_V||this.mainGrid.setEditable(!1);var e="<div id='recinfoArea' /><div id='pagingArea' style='border:none;'/>",t=GPW.layout.mainGridLayout.attachStatusBar({height:28});t.setText(e),this.mainGrid.enablePaging(!0,20,5,"pagingArea",!0,"recInfoArea"),this.mainGrid.setPagingSkin("toolbar","dhx_skyblue"),this.mainGrid.i18n.paging=GLOBAL.paging,this.mainGrid.init(),this.mainGrid.attachEvent("onValidationError",function(e,t,a,r){parent.dhtmlx.message({type:"error",expire:-1,text:"校验错误："+GPW.grid.mainGrid.getColLabel(t)+","+GLOBAL.validText(r)+",字段值不能为["+a+"]！"})});var a=GPW.tree.mainTree,r=a.getSelectedItemId();this.gridDataProcessor=new dataProcessor(GPC.url.updateUrl+"&_value="+r),this.gridDataProcessor.setTransactionMode("REST"),this.gridDataProcessor.setUpdateMode("off"),this.gridDataProcessor.enableDataNames(!0),this.gridDataProcessor.enablePartialDataSend(!0),this.gridDataProcessor.init(this.mainGrid),this.gridDataProcessor.attachEvent("onBeforeDataSending",function(e,t,a){return _.each(a,function(e){e.data&&(e.data=null,delete e.data)}),!0}),this.gridDataProcessor.attachEvent("onAfterUpdate",function(e,t,a,r){if(r instanceof Element&&null!=r.getElementsByTagName("code").item(0)){var i=r.getElementsByTagName("code").item(0).childNodes[0].nodeValue,n=r.getElementsByTagName("message").item(0).childNodes[0].nodeValue;-1==i&&parent.dhtmlx.message({type:"error",expire:-1,text:n})}}),this.mainGrid.attachEvent("onXLE",function(){SpinnerCtl.close()}),this.refreshMainGrid()},sendGridData:function(){this.gridDataProcessor.sendData()},doAfterRefresh:function(){GPW.grid.mainGrid.selectRow(0)},refreshMainGrid:function(e){if(!e){var t=GPW.tree.mainTree,a=t.getSelectedItemId();e=GPC.url.refreshGridUrl+"&_value="+a}this.mainGrid.clearAll(),SpinnerCtl.show(),this.mainGrid.load(e,this.doAfterRefresh,"js")},delectMainGrid:function(){var e=this.mainGrid.getSelectedRowId();return e?void dhtmlx.confirm({ok:"是",cancel:"否",text:"你确定删除此记录吗？ ",callback:function(t){t&&$.ajax({type:"GET",url:GPC.url.delectUrl,data:"id="+e,success:function(){GPW.grid.refreshMainGrid()}})}}):void dhtmlx.alert("请选中一条记录删除！")}},GPW.toolbar={mainToolbar:{},queryNames:GLOBAL.P.P_SIMPLE_QUERY_NAMES,queryValues:GLOBAL.P.P_SIMPLE_QUERY_VALUES,queryOperators:GLOBAL.P.P_SIMPLE_QUERY_OPERATOR,queryFormType:GLOBAL.P.P_SIMPLE_QUERY_FORM_TYPE,treeToolbar:{},initTreeToolbar:function(){this.treeToolbar=GPW.layout.treeLayout.attachToolbar(),this.treeToolbar.setIconsPath(GLOBAL.IconsPath);var e=Array();GLOBAL.S.SEC_C_V&&e.push(Array(GPC.constant.add,"obj","新增节点","new.gif")),GLOBAL.S.SEC_U_V&&e.push(Array(GPC.constant.edit,"obj","修改节点","edit.gif")),GLOBAL.S.SEC_D_V&&e.push(Array(GPC.constant.delect,"obj","删除节点","delect.png")),e.push(Array(GPC.constant.select,"obj","取消选择","cancel.png")),this.treeToolbar.addButtonSelect("edit",0,"编辑",e,"edit.gif","edit_dis.gif"),this.treeToolbar.addSeparator("sep1",1),this.treeToolbar.addButton("refresh",2,"刷新","reload.gif","reload.gif"),this.treeToolbarClick()},treeToolbarClick:function(){this.treeToolbar.attachEvent("onClick",function(e){switch(e){case GPC.constant.add:GPW.window.initTreeWindow(GPC.constant.add);break;case GPC.constant.edit:GPW.window.initTreeWindow(GPC.constant.edit);break;case GPC.constant.delect:GPW.tree.delectTree();break;case GPC.constant.select:GPW.tree.mainTree.clearSelection();break;case"refresh":GPW.tree.mainTree.refreshItem()}})},onChangeQuery:function(){this.addQueryValue()},onChangeQueryOperators:function(){var e=GPW.toolbar.mainToolbar,t=e.getInput("operator").value,a=GPW.toolbar.mainToolbar.getInput("queryName"),r=a.value;t==GPC.constant.between?this.addBetweenValue(r):this.addOtherValue(r)},addBetweenValue:function(e){this.mainToolbar.removeItem("queryValue"),this.mainToolbar.removeItem("queryBegin"),this.mainToolbar.removeItem("queryEnd"),this.mainToolbar.removeItem("text_do"),this.mainToolbar.addInput("queryBegin",3,"",100),this.mainToolbar.addText("text_do",4,"到"),this.mainToolbar.addInput("queryEnd",5,"",100);var t;if(_.map(this.queryFormType,function(a,r){return r==e?void(t=a):void 0}),"calendar"==t){new dhtmlXCalendarObject(this.mainToolbar.getInput("queryBegin")),new dhtmlXCalendarObject(this.mainToolbar.getInput("queryEnd"))}},addOtherValue:function(e){var t=GPW.toolbar.mainToolbar,a=!1;if(_.map(this.queryValues,function(r,i){i==e&&(t.removeItem("queryValue"),t.removeItem("queryBegin"),t.removeItem("text_do"),t.removeItem("queryEnd"),t.addSelectEx("queryValue",3,r,100),a=!0)}),!a){t.removeItem("queryValue"),t.removeItem("queryBegin"),t.removeItem("text_do"),t.removeItem("queryEnd");var r;_.map(this.queryFormType,function(t,a){return a==e?void(r=t):void 0}),t.addInput("queryValue",3,"",200),"calendar"==r&&new dhtmlXCalendarObject(t.getInput("queryValue"))}},addOperator:function(e){var t=GPW.toolbar.mainToolbar;_.find(this.queryOperators,function(a,r){return r==e?(t.removeItem("operator"),void t.addSelectEx("operator",2,a,70,"GPW.toolbar.onChangeQueryOperators()")):void 0})},addQueryName:function(){this.mainToolbar.addSelectEx("queryName",1,this.queryNames,100,"GPW.toolbar.onChangeQuery()")},addQueryValue:function(){var e=GPW.toolbar.mainToolbar.getInput("queryName"),t=e.value,a=this,r=a.mainToolbar;a.addOperator(t);var i=r.getInput("operator").value;i==GPC.constant.between?this.addBetweenValue(t):this.addOtherValue(t)},init:function(){this.mainToolbar=GPW.layout.mainGridLayout.attachToolbar();var e=this.mainToolbar,t=Array();GLOBAL.S.SEC_C_V&&t.push(Array(GPC.constant.add,"obj","新增","new.gif")),GLOBAL.S.SEC_U_V&&t.push(Array(GPC.constant.edit,"obj","修改","edit.gif")),GLOBAL.S.SEC_D_V&&t.push(Array(GPC.constant.delect,"obj","删除","delect.png")),e.setIconsPath(GLOBAL.IconsPath),e.addText("text_select",0,"选"),this.addQueryName();var a=e.getInput("queryName").value;this.addOperator(a),this.addQueryValue(),e.addButton("query",9,"查询","search.gif","search_dis.gif"),e.addSeparator("sep1",10),e.addButton("detailQuery",12,"详细查询","search.png","search.png"),(GLOBAL.S.SEC_U_V||GLOBAL.S.SEC_C_V||GLOBAL.S.SEC_D_V)&&e.addButtonSelect("edit",15,"编辑",t,"edit.gif","edit_dis.gif"),GLOBAL.S.SEC_U_V&&e.addButton("update",16,"更新","cut.gif","cut_dis.gif"),e.addButton("maximized",20,"全屏","fullscreen_mode.gif","fullscreen_mode.gif"),this.mainToolbarClick()},mainToolbarClick:function(){this.mainToolbar.attachEvent("onClick",function(e){switch(e){case GPC.constant.add:GPW.window.initMainWindow(GPC.constant.add);break;case GPC.constant.edit:GPW.window.initMainWindow(GPC.constant.edit);break;case GPC.constant.delect:GPW.grid.delectMainGrid();break;case GPC.constant.query:var t=GPW.toolbar.mainToolbar,a=t.getInput("queryName").value,r=t.getInput("operator").value,i=new Array;if(r==GPC.constant.between){var n=t.getInput("queryBegin").value,o=t.getInput("queryEnd").value;i[0]=GLOBAL.getBetweenQueryObjct(a,r,n,o)}else{var d=t.getInput("queryValue").value;i[0]=GLOBAL.getQueryObjct(a,r,d)}var s=JSON.stringify(i),l=GPW.tree.mainTree,u=l.getSelectedItemId(),c=GPC.url.queryUrl+"&_value="+u+"&_json="+encodeURI(s);GPW.grid.refreshMainGrid(c);break;case GPC.constant.detailQuery:GPW.window.initDetailQueryWindow();break;case GPC.constant.update:GPW.grid.sendGridData();break;case"maximized":var m=GPW.layout,t=GPW.toolbar.mainToolbar;GLOBAL.P.MAXIMIZED?(m.treeLayout.expand(),t.setItemText("maximized","全屏"),t.setItemImage("maximized","fullscreen_mode.gif"),GLOBAL.P.MAXIMIZED=!1):(m.treeLayout.collapse(),t.setItemText("maximized","恢复"),t.setItemImage("maximized","selection.gif"),GLOBAL.P.MAXIMIZED=!0)}})}},GPW.window={handle:{},treeWindow:{},mainWindow:{},subWindow:{},createWindow:function(){this.initHandle(),this.handle.attachViewportTo("layoutObj"),this.mainWindow=this.handle.createWindow("w1",$("#layoutObj").width()/2-350,30,700,480)},initHandle:function(){return this.handle=new dhtmlXWindows,this.handle},initMainWindow:function(e){if(e==GPC.constant.edit){var t=GPW.grid.mainGrid.getSelectedRowId();if(!t)return void dhtmlx.alert("请选中一条记录！")}this.createWindow(),this.mainWindow.setText(e==GPC.constant.add?"新增":"修改"),this.mainWindow.setModal(!0),GPW.form.init(this.mainWindow,e)},initDetailQueryWindow:function(){GPW.cache.grid=GPW.grid.mainGrid,this.createWindow(),this.mainWindow.setText("详细查询"),this.mainWindow.setModal(!0);var e=GPW.tree.mainTree,t=e.getSelectedItemId();this.mainWindow.attachURL(GPC.url.detailQueryUrl+"&_value="+t)},initTreeWindow:function(e){this.initHandle(),this.handle.attachViewportTo("layoutObj"),this.treeWindow=this.handle.createWindow("w1",$("#layoutObj").width()/2-350,30,700,380),this.treeWindow.setText(e==GPC.constant.add?"新增树节点":"修改树节点"),this.treeWindow.setModal(!0),GPW.form.initTreeForm(this.treeWindow,e)}},GPW.form={mainForm:{},treeForm:{},getTreeFormData:function(){return GLOBAL.P.TREE_P_FORM},updateTreeFromData:function(){var e=GPW.tree.mainTree.getSelectedItemId(),t=this;$.ajax({cache:!1,type:"GET",url:GPC.url.treeGetUrl,data:"id="+e,success:function(e){t.treeForm.load(e)}})},initTreeForm:function(e,t){var a=this.getTreeFormData();this.treeForm=this.getForm(e,a,"tree");GPW.tree.mainTree;t==GPC.constant.edit&&this.updateTreeFromData(),this.treeForm.attachEvent("onInfo",function(e,t){GLOBAL.PopupFunction(t,this.getUserData(e,"info"))}),this.treeForm.attachEvent("onButtonClick",function(e){"save"==e&&GPW.form.treeForm.send(GPC.url.treeSave,function(e,t){GPW.window.handle.unload(),GLOBAL.errorMessage(t),GPW.tree.mainTree.refreshItem()})})},getMainFormData:function(){return GLOBAL.P.P_FORM},updateMainFromData:function(){var e=GPW.grid.mainGrid,t=e.getSelectedRowId();e.forEachCell(t,function(t,a){var r=e.getColumnId(a);GPW.form.mainForm.setItemValue(r,_.unescape(t.getValue()))}),GPW.form.mainForm.setItemValue("id",t)},getForm:function(e,t){return e.attachForm(t)},init:function(e,t){var a=this.getMainFormData();this.mainForm=this.getForm(e,a),t==GPC.constant.edit&&this.updateMainFromData(),this.mainForm.attachEvent("onInfo",function(e,t){GLOBAL.PopupFunction(t,this.getUserData(e,"info"))}),this.mainForm.attachEvent("onButtonClick",function(e){if("save"==e){var t=GPW.tree.mainTree,a=t.getSelectedItemId();if(!a)return void alert("请选择树节点！");SpinnerCtl.show(),GPW.form.mainForm.send(GPC.url.saveUrl+"&_value="+a,function(e,t){SpinnerCtl.close(),GPW.window.handle.unload(),GLOBAL.errorMessage(t),GPW.grid.refreshMainGrid()})}}),this.mainForm.attachEvent("onValidateError",function(e,t){parent.dhtmlx.message({type:"error",expire:-1,text:"校验错误："+GPW.form.mainForm.getItemLabel(e)+"字段值不能为["+t+"]！"})})}},$(function(){GPW.layout.init(),GPW.tree.init(),GPW.toolbar.initTreeToolbar(),GPW.grid.init(),GPW.toolbar.init()}),dhtmlxValidation.isValidIntegerEmpty=function(e){return""==e?!0:dhtmlxValidation.isValidInteger(e)},dhtmlxValidation.isValidNumericEmpty=function(e){return""==e?!0:dhtmlxValidation.isValidNumeric(e)};