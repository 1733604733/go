$(window).resize(function(){GPW.layout.mainLayout.setSizes()});var GPC={url:{refreshGridUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/loadPage/"+GLOBAL.P.CLASSNAME,queryUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/queryPage/"+GLOBAL.P.CLASSNAME,saveUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/save/"+GLOBAL.P.CLASSNAME,detailQueryUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/tpl/DetailQuery/"+GLOBAL.P.CLASSNAME+"/d",updateUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/updateAll/"+GLOBAL.P.CLASSNAME+"?format=xml",delectUrl:GLOBAL.S.URL+GLOBAL.P.MODULES+"/a/delect/"+GLOBAL.P.CLASSNAME,loadActiveTabUrl:GLOBAL.S.URL+GLOBAL.P.MODULES},constant:{add:"add",edit:"edit",delect:"delect",query:"query",update:"update",detailQuery:"detailQuery",between:"between"}},GPW={layout:{},toolbar:{},grid:{},window:{},form:{},paging:{},cache:{}};GPW.cache={grid:{}},GPW.layout={mainLayout:{},mainGridLayout:{},tabbarLayout:{},init:function(){this.mainLayout=new dhtmlXLayoutObject("layoutObj","2U"),this.mainGridLayout=this.mainLayout.cells("a"),this.mainGridLayout.setWidth(720),this.mainGridLayout.hideHeader(),this.tabbarLayout=this.mainLayout.cells("b"),this.tabbarLayout.hideHeader()}},GPW.grid={mainGrid:{},gridDataProcessor:{},init:function(){this.mainGrid=GPW.layout.mainGridLayout.attachGrid(),this.mainGrid.setImagePath(GLOBAL.IconsPath),this.mainGrid.setHeader(GLOBAL.P.TOP_P_GRID_HEADER),this.mainGrid.setColumnIds(GLOBAL.P.TOP_P_GRID_COLUMNIDS),this.mainGrid.setInitWidths(GLOBAL.P.TOP_P_GRID_WIDTH),this.mainGrid.setColAlign(GLOBAL.P.TOP_P_GRID_COLALIGN),this.mainGrid.setColTypes(GLOBAL.P.TOP_P_GRID_COLTYPES),this.mainGrid.setColSorting(GLOBAL.P.TOP_P_GRID_COLSORTING),this.mainGrid.setColValidators(GLOBAL.P.TOP_P_GRID_VALIDATORS),GLOBAL.initGridCombo(this.mainGrid,GLOBAL.P.TOP_P_GRID_FORMGRIDASSEMBLE),this.mainGrid.setDateFormat("%Y-%m-%d");var t="<div id='recinfoArea' /><div id='pagingArea' style='border:none;'/>",e=GPW.layout.mainGridLayout.attachStatusBar({height:28});e.setText(t),this.mainGrid.enablePaging(!0,20,5,"pagingArea",!0,"recInfoArea"),this.mainGrid.setPagingSkin("toolbar","dhx_skyblue"),this.mainGrid.i18n.paging=GLOBAL.paging,this.mainGrid.init(),this.mainGrid.attachEvent("onValidationError",function(t,e,a,i){parent.dhtmlx.message({type:"error",expire:-1,text:"校验错误："+GPW.grid.mainGrid.getColLabel(e)+","+GLOBAL.validText(i)+",字段值不能为["+a+"]！"})}),this.gridDataProcessor=new dataProcessor(GPC.url.updateUrl),this.gridDataProcessor.setTransactionMode("REST"),this.gridDataProcessor.setUpdateMode("off"),this.gridDataProcessor.enableDataNames(!0),this.gridDataProcessor.enablePartialDataSend(!0),this.gridDataProcessor.init(this.mainGrid),this.gridDataProcessor.attachEvent("onBeforeDataSending",function(t,e,a){return _.each(a,function(t){t.data&&(t.data=null,delete t.data)}),!0}),this.gridDataProcessor.attachEvent("onAfterUpdate",function(t,e,a,i){if(i instanceof Element&&null!=i.getElementsByTagName("code").item(0)){var r=i.getElementsByTagName("code").item(0).childNodes[0].nodeValue,n=i.getElementsByTagName("message").item(0).childNodes[0].nodeValue;-1==r&&parent.dhtmlx.message({type:"error",expire:-1,text:n})}}),this.refreshMainGrid(),this.mainGrid.attachEvent("onRowSelect",function(t){GPW.tabbar.loadActiveTab(t)})},sendGridData:function(){this.gridDataProcessor.sendData()},doAfterRefresh:function(){var t=GPW.grid.mainGrid;t.selectRow(0);var e=t.getSelectedRowId();null!=e&&GPW.tabbar.loadActiveTab(e)},refreshMainGrid:function(t){t||(t=GPC.url.refreshGridUrl),this.mainGrid.clearAll(),this.mainGrid.load(t,this.doAfterRefresh,"js")},delectMainGrid:function(){var t=this.mainGrid.getSelectedRowId();return t?void dhtmlx.confirm({ok:"是",cancel:"否",text:"你确定删除此记录吗？ ",callback:function(e){e&&$.ajax({type:"GET",url:GPC.url.delectUrl,data:"id="+t,success:function(){GPW.grid.refreshMainGrid()}})}}):void dhtmlx.alert("请选中一条记录删除！")}},GPW.toolbar={mainToolbar:{},queryNames:GLOBAL.P.TOP_P_SIMPLE_QUERY_NAMES,queryValues:GLOBAL.P.TOP_P_SIMPLE_QUERY_VALUES,queryOperators:GLOBAL.P.TOP_P_SIMPLE_QUERY_OPERATOR,queryFormType:GLOBAL.P.TOP_P_SIMPLE_QUERY_FORM_TYPE,onChangeQuery:function(){this.addQueryValue()},onChangeQueryOperators:function(){var t=GPW.toolbar.mainToolbar,e=t.getInput("operator").value,a=GPW.toolbar.mainToolbar.getInput("queryName"),i=a.value;e==GPC.constant.between?this.addBetweenValue(i):this.addOtherValue(i)},addBetweenValue:function(t){this.mainToolbar.removeItem("queryValue"),this.mainToolbar.removeItem("queryBegin"),this.mainToolbar.removeItem("queryEnd"),this.mainToolbar.removeItem("text_do"),this.mainToolbar.addInput("queryBegin",3,"",100),this.mainToolbar.addText("text_do",4,"到"),this.mainToolbar.addInput("queryEnd",5,"",100);var e;if(_.map(this.queryFormType,function(a,i){return i==t?void(e=a):void 0}),"calendar"==e){new dhtmlXCalendarObject(this.mainToolbar.getInput("queryBegin")),new dhtmlXCalendarObject(this.mainToolbar.getInput("queryEnd"))}},addOtherValue:function(t){var e=GPW.toolbar.mainToolbar,a=!1;if(_.map(this.queryValues,function(i,r){r==t&&(e.removeItem("queryValue"),e.removeItem("queryBegin"),e.removeItem("text_do"),e.removeItem("queryEnd"),e.addSelectEx("queryValue",3,i,100),a=!0)}),!a){e.removeItem("queryValue"),e.removeItem("queryBegin"),e.removeItem("text_do"),e.removeItem("queryEnd");var i;_.map(this.queryFormType,function(e,a){return a==t?void(i=e):void 0}),e.addInput("queryValue",3,"",200),"calendar"==i&&new dhtmlXCalendarObject(e.getInput("queryValue"))}},addOperator:function(t){var e=GPW.toolbar.mainToolbar;_.find(this.queryOperators,function(a,i){return i==t?(e.removeItem("operator"),void e.addSelectEx("operator",2,a,70,"GPW.toolbar.onChangeQueryOperators()")):void 0})},addQueryName:function(){this.mainToolbar.addSelectEx("queryName",1,this.queryNames,100,"GPW.toolbar.onChangeQuery()")},addQueryValue:function(){var t=GPW.toolbar.mainToolbar.getInput("queryName"),e=t.value,a=this,i=a.mainToolbar;a.addOperator(e);var r=i.getInput("operator").value;r==GPC.constant.between?this.addBetweenValue(e):this.addOtherValue(e)},init:function(){this.mainToolbar=GPW.layout.mainGridLayout.attachToolbar();var t=this.mainToolbar,e=Array(Array(GPC.constant.add,"obj","新增","stylesheet.gif"),Array(GPC.constant.edit,"obj","修改","database.gif"),Array(GPC.constant.delect,"obj","删除","presentation.gif"));t.setIconsPath(GLOBAL.IconsPath),t.addText("text_select",0,"选"),this.addQueryName();var a=t.getInput("queryName").value;this.addOperator(a),this.addQueryValue(),t.addButton("query",9,"查询","new.gif","new_dis.gif"),t.addSeparator("sep1",10),t.addButton("detailQuery",12,"详细查询","new.gif","new_dis.gif"),t.addButtonSelect("edit",15,"编辑",e,"new.gif","new_dis.gif"),t.addButton("update",16,"更新","new.gif","new_dis.gif"),this.mainToolbarClick()},mainToolbarClick:function(){this.mainToolbar.attachEvent("onClick",function(t){switch(t){case GPC.constant.add:GPW.window.initMainWindow(GPC.constant.add);break;case GPC.constant.edit:GPW.window.initMainWindow(GPC.constant.edit);break;case GPC.constant.delect:GPW.grid.delectMainGrid();break;case GPC.constant.query:var e=GPW.toolbar.mainToolbar,a=e.getInput("queryName").value,i=e.getInput("operator").value,r=new Array;if(i==GPC.constant.between){var n=e.getInput("queryBegin").value,o=e.getInput("queryEnd").value;r[0]=GLOBAL.getBetweenQueryObjct(a,i,n,o)}else{var d=e.getInput("queryValue").value;r[0]=GLOBAL.getQueryObjct(a,i,d)}var s=JSON.stringify(r),u=GPC.url.queryUrl+"?_json="+encodeURI(s);GPW.grid.refreshMainGrid(u);break;case GPC.constant.detailQuery:GPW.window.initDetailQueryWindow();break;case GPC.constant.update:GPW.grid.sendGridData();break;case"refresh":}})}},GPW.window={handle:{},mainWindow:{},createWindow:function(){parent.GPW?(this.mainWindow=parent.GPW.window.initSubWindow(),parent.GPW.cache.grid=GPW.grid.mainGrid):(this.initHandle(),this.handle.attachViewportTo("layoutObj"),this.mainWindow=this.handle.createWindow("w1",$("#layoutObj").width()/2-350,30,700,480))},initHandle:function(){return this.handle=new dhtmlXWindows,this.handle},initMainWindow:function(t){if(t==GPC.constant.edit){var e=GPW.grid.mainGrid.getSelectedRowId();if(!e)return void dhtmlx.alert("请选中一条记录！")}this.createWindow(),this.mainWindow.setText(t==GPC.constant.add?"新增":"修改"),this.mainWindow.setModal(!0),GPW.form.init(this.mainWindow,t)},initDetailQueryWindow:function(){GPW.cache.grid=GPW.grid.mainGrid,this.createWindow(),this.mainWindow.setText("详细查询"),this.mainWindow.setModal(!0),this.mainWindow.attachURL(GPC.url.detailQueryUrl)}},GPW.form={mainForm:{},getMainFormData:function(){return GLOBAL.P.TOP_P_FORM},updateMainFromData:function(){var t=GPW.grid.mainGrid,e=t.getSelectedRowId();t.forEachCell(e,function(e,a){var i=t.getColumnId(a);GPW.form.mainForm.setItemValue(i,_.unescape(e.getValue()))}),GPW.form.mainForm.setItemValue("id",e)},init:function(t,e){var a=this.getMainFormData();this.mainForm=t.attachForm(),this.mainForm.loadStruct(a,"json"),e==GPC.constant.edit&&this.updateMainFromData(),this.mainForm.attachEvent("onButtonClick",function(t){"save"==t&&GPW.form.mainForm.send(GPC.url.saveUrl,function(t,e){var a;a=parent.GPW?parent.GPW.window:GPW.window,a.handle.unload(),GLOBAL.errorMessage(e),GPW.grid.refreshMainGrid()})}),this.mainForm.attachEvent("onValidateError",function(t,e){parent.dhtmlx.message({type:"error",expire:-1,text:"校验错误："+GPW.form.mainForm.getItemLabel(t)+"字段值不能为["+e+"]！"})})}},GPW.tabbar={subListTabbar:{},initSubList:function(){this.subListTabbar=GPW.layout.tabbarLayout.attachTabbar({tabs:[{id:"users",text:"用户",active:!0}]}),this.subListTabbar.attachEvent("onSelect",function(t){var e=GPW.grid.typeGrid,a=e.getSelectedRowId(),i=GPC.url.loadActiveTabUrl+"/"+t+"?_key=users&_value="+a;return GPW.tabbar.subListTabbar.tabs(t).attachURL(i),!0})},loadActiveTab:function(t){var e=this.subListTabbar.getActiveTab(),a=GPC.url.loadActiveTabUrl+"/"+e+"?_key=users&_value="+t;this.subListTabbar.tabs(e).attachURL(a)}},$(function(){GPW.layout.init(),GPW.grid.init(),GPW.toolbar.init(),GPW.tabbar.initSubList()}),dhtmlxValidation.isValidIntegerEmpty=function(t){return""==t?!0:dhtmlxValidation.isValidInteger(t)},dhtmlxValidation.isValidNumericEmpty=function(t){return""==t?!0:dhtmlxValidation.isValidNumeric(t)};